<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset Comparison Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .container { margin-top: 50px; max-width: 900px; }
        .card { padding: 30px; border-radius: 15px; box-shadow: 0px 4px 12px rgba(0,0,0,0.1); }
        .spinner-border { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h3 class="text-center mb-4">ðŸ“Š Dataset Comparison Tool</h3>

            <form id="compareForm" enctype="multipart/form-data">
                <div class="row mb-3">
                    <div class="col">
                        <label>Upload File 1</label>
                        <input type="file" id="file1" name="file1" class="form-control" required>
                    </div>
                    <div class="col">
                        <label>Upload File 2</label>
                        <input type="file" id="file2" name="file2" class="form-control" required>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label>Unique Column (File 1)</label>
                        <select id="unique_column_file1" name="unique_column_file1" class="form-select" required></select>
                    </div>
                    <div class="col">
                        <label>Unique Column (File 2)</label>
                        <select id="unique_column_file2" name="unique_column_file2" class="form-select" required></select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label>Compare Column (File 1)</label>
                        <select id="compare_column_file1" name="compare_column_file1" class="form-select" required></select>
                    </div>
                    <div class="col">
                        <label>Compare Column (File 2)</label>
                        <select id="compare_column_file2" name="compare_column_file2" class="form-select" required></select>
                    </div>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-primary">Compare Files</button>
                    <div class="spinner-border text-primary ms-3" role="status" id="loadingSpinner">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        function fetchHeaders(){
            let formData = new FormData();
            if ($("#file1")[0].files.length > 0) {
                formData.append("file1", $("#file1")[0].files[0]);
            }
            if ($("#file2")[0].files.length > 0) {
                formData.append("file2", $("#file2")[0].files[0]);
            }

            $.ajax({
                url: "/get_headers",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function(data){
                    $("#unique_column_file1, #compare_column_file1").empty();
                    $("#unique_column_file2, #compare_column_file2").empty();

                    data.file1_headers.forEach(col => {
                        $("#unique_column_file1, #compare_column_file1").append(new Option(col, col));
                    });
                    data.file2_headers.forEach(col => {
                        $("#unique_column_file2, #compare_column_file2").append(new Option(col, col));
                    });
                }
            });
        }

        $("#file1, #file2").on("change", fetchHeaders);

        $("#compareForm").on("submit", function(e){
            e.preventDefault();
            $("#loadingSpinner").show();

            $.ajax({
                url: "/compare",
                type: "POST",
                data: new FormData(this),
                processData: false,
                contentType: false,
                xhrFields: { responseType: 'blob' },
                success: function(data){
                    $("#loadingSpinner").hide();
                    let url = window.URL.createObjectURL(data);
                    let a = document.createElement("a");
                    a.href = url;
                    a.download = "comparison_result.xlsx";
                    a.click();
                },
                error: function(){
                    $("#loadingSpinner").hide();
                    alert("Error during comparison. Please try again.");
                }
            });
        });
    </script>
</body>
</html>


